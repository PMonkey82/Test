<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>Lupo Solitario — Foglio di Battaglia</title>
<meta name="theme-color" content="#1c1710">
<style>
  :root{
    --bg:#1c1710; --panel:#231c13; --ink:#e8dec7; --muted:#b9ae95; --accent:#caa25d; --accent-dark:#8a6a2c;
    --emerald:#34d399; --emerald-ink:#c8f3df; --ring:#caa25d55;
    --rule:#6e5a3344; --paper:#1b160f; --shadow:#00000066;
    --mono: ui-monospace, Menlo, Monaco, Consolas, "Courier New", monospace;
    --serif: "Palatino Linotype", Palatino, "Times New Roman", Georgia, serif;
    --sans: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Noto Sans", Helvetica, Arial;
    --emerald-dim:#2b8d6d; --danger:#c24a4a; --gold:#caa25d;
  }
  *{ box-sizing:border-box; }
  html,body{ margin:0; }
  body{
    color: var(--ink);
    background:
      radial-gradient(1200px 600px at 20% 0%, #2c2216 0, transparent 60%),
      radial-gradient(1000px 700px at 100% 100%, #2a200f 0, transparent 70%),
      var(--bg);
    font-family: var(--serif);
    -webkit-font-smoothing: antialiased;
  }
  .wrap{ max-width: 1040px; margin:auto; padding:14px; display:grid; gap:14px }
  header{ text-align:center; border-bottom:3px double #6e5a33; padding:8px 0 10px }
  h1{ font-size: clamp(22px, 6vw, 36px); margin:0; font-variant: small-caps; letter-spacing:.06em }
  .subtitle{ margin-top:2px; color:var(--muted); font-variant: small-caps; letter-spacing:.06em }
  .toolbar{ display:flex; flex-wrap:wrap; gap:8px; justify-content:center; align-items:center; margin-top:10px }
  .toolbar .btn{ padding:8px 10px }
  .autosaveRow{ display:flex; flex-wrap:wrap; gap:10px; justify-content:center; align-items:center; color:var(--muted); font-family:var(--sans); font-size:14px }
  select, .num{ background:#1b160f; border:1px solid var(--rule); color:var(--ink); border-radius:10px; padding:8px 10px; font-family:var(--sans) }
  .card{
    background: var(--panel); border:1px solid var(--rule); border-radius:16px; padding:14px;
    box-shadow: 0 14px 40px var(--shadow), inset 0 0 60px #00000033;
  }
  .h2{ font-size:18px; font-variant: small-caps; letter-spacing:.06em; margin:0 0 8px }
  .grid{ display:grid; gap:14px }
  @media (min-width: 880px){ .grid.cols-2{ grid-template-columns: 1.1fr 1fr; } }
  .panel{
    border:1px solid var(--rule); border-radius:12px; background: var(--paper);
    box-shadow: inset 0 0 40px #00000045; padding:12px;
  }
  /* Square-ish controls */
  .square{ display:grid; grid-template-columns: auto 64px auto; align-items:center; gap:6px }
  .square input[type="number"]{ width:64px }
  .bigValue{
    text-align:center; font-weight:900; color:var(--emerald); font-family:var(--mono);
    font-size: clamp(44px, 12vw, 72px); line-height:1; padding:8px 0; background:#17120b; border:1px solid var(--rule); border-radius:12px;
    box-shadow: inset 0 0 0 1px #2f7f5d55;
  }
  .split{ display:grid; grid-template-columns: 1fr auto 1fr; align-items:center; gap:10px; }
  .slash{ font-size: clamp(28px, 9vw, 48px); color:var(--muted); }
  .boxLabel{ font-family:var(--sans); font-size:12px; color:var(--muted); text-align:center }
  .stepper{ display:flex; gap:6px; align-items:center }
  .mini{ padding:10px 12px; border-radius:10px; border:1px solid #6e5a3344; background:#2a2216; color:#f0e6cd; font-weight:800; touch-action: manipulation; }
  input[type="number"]{
    width:100%; padding:10px 10px; border-radius:12px; border:1px solid #6e5a3355; background:#1b160f;
    color:var(--emerald-ink); font-family:var(--mono); box-shadow: inset 0 0 0 1px #2f7f5d55; appearance:textfield; font-size:18px; text-align:center;
  }
  input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button{ display:none }
  .modsGrid{ display:grid; grid-template-columns: repeat(5, 1fr); gap:8px; }
  .modBox{ text-align:center }
  .modBox label{ display:block; font-family:var(--sans); font-size:11px; color:var(--muted); margin-bottom:4px }
  .modBox input{ text-align:center }
  .modBox.readonly input{ opacity:.85; background:#17120b; pointer-events:none }
  .row{ display:flex; align-items:center; gap:8px; flex-wrap:wrap }
  .btn{ border:2px solid var(--accent-dark); background:linear-gradient(180deg, #7a6330, #5a4620); color:#f2e6c7;
        padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer; text-transform: uppercase; letter-spacing:.6px; }
  .btn:active{ transform: translateY(1px) }
  /* Armamento */
  .armBox{ background:#17120b; border:1px solid var(--rule); border-radius:10px; padding:8px }
  .armLine{ padding:8px; border:1px dashed var(--rule); border-radius:8px; min-height:36px; display:flex; align-items:center; font-family:var(--sans) }
  .armLine + .armLine{ margin-top:6px }
  .weaponList{ width:100%; border-collapse:collapse }
  .weaponList th, .weaponList td{ border-bottom:1px solid var(--rule); padding:4px 6px } /* compact rows */
  .weaponList th{ background:#2a2216; text-align:left; font-variant: small-caps }
  .wName{ font-weight:700 }
  .wDisc{ width:40px; text-align:center }
  .rightPack{ text-align:right; white-space:nowrap }
  .modCompact{ max-width:70px; display:inline-block; vertical-align:middle; text-align:center }
  .equipCompact{ display:inline-block; width:28px; text-align:center }
  .kaiGrid{ display:grid; gap:10px; }
  @media (min-width: 860px){ .kaiGrid{ grid-template-columns: 1fr 1fr; } }
  /* Toast */
  .toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:18px; background:#2a2216; color:#f5e9cc; border:1px solid #6e5a33; padding:10px 14px; border-radius:10px; box-shadow:0 10px 30px #0008; opacity:0; pointer-events:none; transition:opacity .2s, transform .2s }
  .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px) }
  /* Mute */
  .muteRow{ display:flex; gap:10px; justify-content:center; align-items:center; color:var(--muted); font-family:var(--sans); font-size:14px }
  /* Subtle highlight for Disciplina row */
  tr.kaiFav{ outline: 1px solid #2f7f5d88; background:#1c1710 }
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Lupo Solitario</h1>
      <div class="subtitle">Foglio di Battaglia</div>

      <!-- Toolbar row -->
      <div class="toolbar">
        <button class="btn" id="restore1">Slot 1</button>
        <button class="btn" id="restore2">Slot 2</button>
        <button class="btn" id="restore3">Slot 3</button>
        <button class="btn" id="saveNow">Salva ora</button>
        <span class="small">Ultimo salvataggio: <span id="lastSave">—</span></span>
      </div>

      <!-- Autosave row -->
      <div class="autosaveRow">
        <label><input type="checkbox" id="autosave" checked> Autosalvataggio</label>
        <label>Intervallo
          <select id="autosaveMins">
            <option value="1">1 min</option>
            <option value="3">3 min</option>
            <option value="5" selected>5 min</option>
            <option value="10">10 min</option>
            <option value="30">30 min</option>
          </select>
        </label>
      </div>
      <div class="muteRow">
        <label><input type="checkbox" id="muteToggle"> Muta suoni</label>
      </div>
    </header>

    <div class="grid cols-2">
      <!-- Combattività -->
      <section class="card">
        <h2 class="h2">Combattività</h2>
        <div class="panel">
          <div class="boxLabel">Totale</div>
          <div id="cmbTotal" class="bigValue">0</div>
          <div class="boxLabel">Base</div>
          <div class="square">
            <button class="mini" type="button" data-step="cmbBase" data-delta="-1">−</button>
            <input class="num" type="number" id="cmbBase" value="0" inputmode="numeric" pattern="[0-9]*">
            <button class="mini" type="button" data-step="cmbBase" data-delta="1">+</button>
          </div>
        </div>
        <div class="panel" style="margin-top:10px">
          <div class="h2" style="margin:0 0 6px">Modificatori</div>
          <div class="modsGrid">
            <div class="modBox readonly"><label>Disciplina (Kai)</label><input type="number" id="cmbW1" value="0" readonly></div>
            <div class="modBox"><label>Talento</label><input type="number" id="cmbM1" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Oggetto</label><input type="number" id="cmbM2" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Circostanza</label><input type="number" id="cmbM3" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox readonly"><label>—</label><input type="number" id="cmbW2" value="0" readonly></div>
          </div>
          <div class="hint">Se nessuna arma è equipaggiata: malus automatico <strong>−4</strong>.</div>
        </div>
      </section>

      <!-- Resistenza -->
      <section class="card">
        <h2 class="h2">Resistenza</h2>
        <div class="panel">
          <div class="boxLabel">Attuale / Totale</div>
          <div class="split">
            <div class="square">
              <button class="mini" type="button" data-step="endCur" data-delta="-1">−</button>
              <input class="num" type="number" id="endCur" value="0" inputmode="numeric" pattern="[0-9]*">
              <button class="mini" type="button" data-step="endCur" data-delta="1">+</button>
            </div>
            <div class="slash">/</div>
            <div class="square">
              <button class="mini" type="button" data-step="endTot" data-delta="-1">−</button>
              <input class="num" type="number" id="endTot" value="0" inputmode="numeric" pattern="[0-9]*">
              <button class="mini" type="button" data-step="endTot" data-delta="1">+</button>
            </div>
          </div>
        </div>
        <div class="panel" style="margin-top:10px">
          <div class="h2" style="margin:0 0 6px">Modificatori Resistenza</div>
          <div class="modsGrid">
            <div class="modBox"><label>Mod 1</label><input type="number" id="endM1" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Mod 2</label><input type="number" id="endM2" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Mod 3</label><input type="number" id="endM3" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Mod 4</label><input type="number" id="endM4" value="0" inputmode="numeric" pattern="[0-9]*"></div>
            <div class="modBox"><label>Mod 5</label><input type="number" id="endM5" value="0" inputmode="numeric" pattern="[0-9]*"></div>
          </div>
        </div>
      </section>
    </div>

    <!-- Armamento -->
    <section class="card">
      <h2 class="h2">Armamento</h2>
      <div class="panel">
        <div class="row">
          <div class="armBox" style="flex:1">
            <div class="armLine" id="armLine1">—</div>
            <div class="armLine" id="armLine2">—</div>
          </div>
          <div class="row" style="min-width: 240px; justify-content:center">
            <span class="small">Massimo 2 armi equipaggiate.</span>
          </div>
        </div>
      </div>

      <div class="panel" style="margin-top:10px">
        <h2 class="h2" style="margin:0 0 6px">Disciplina della Scherma Kai</h2>
        <div class="small" style="margin-bottom:8px">Spunta <strong>una sola</strong> arma come Disciplina (Kai) — ottieni <strong>+2</strong> se anche “Equip”. A destra imposta il <em>Mod</em> e usa ± o input. Righe più compatte.</div>
        <div class="kaiGrid">
          <table class="weaponList" id="weaponLeft">
            <thead><tr><th class="wDisc">Disc.</th><th>Arma</th><th class="rightPack" colspan="2">Mod &nbsp; Equip.</th></tr></thead>
            <tbody>
              <tr data-name="Asta"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Asta</td><td class="rightPack"><button class="mini" data-step="wmod-Asta" data-delta="-1">−</button><input class="modCompact" id="wmod-Asta" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Asta" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Spada"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Spada</td><td class="rightPack"><button class="mini" data-step="wmod-Spada" data-delta="-1">−</button><input class="modCompact" id="wmod-Spada" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Spada" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Daga"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Daga</td><td class="rightPack"><button class="mini" data-step="wmod-Daga" data-delta="-1">−</button><input class="modCompact" id="wmod-Daga" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Daga" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Martello"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Martello</td><td class="rightPack"><button class="mini" data-step="wmod-Martello" data-delta="-1">−</button><input class="modCompact" id="wmod-Martello" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Martello" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Pugnale"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Pugnale</td><td class="rightPack"><button class="mini" data-step="wmod-Pugnale" data-delta="-1">−</button><input class="modCompact" id="wmod-Pugnale" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Pugnale" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
            </tbody>
          </table>
          <table class="weaponList" id="weaponRight">
            <thead><tr><th class="wDisc">Disc.</th><th>Arma</th><th class="rightPack" colspan="2">Mod &nbsp; Equip.</th></tr></thead>
            <tbody>
              <tr data-name="Lancia"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Lancia</td><td class="rightPack"><button class="mini" data-step="wmod-Lancia" data-delta="-1">−</button><input class="modCompact" id="wmod-Lancia" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Lancia" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Spadone"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Spadone</td><td class="rightPack"><button class="mini" data-step="wmod-Spadone" data-delta="-1">−</button><input class="modCompact" id="wmod-Spadone" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Spadone" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Ascia"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Ascia</td><td class="rightPack"><button class="mini" data-step="wmod-Ascia" data-delta="-1">−</button><input class="modCompact" id="wmod-Ascia" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Ascia" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
              <tr data-name="Mazza"><td class="wDisc"><input type="checkbox" data-act="disc"></td><td class="wName">Mazza</td><td class="rightPack"><button class="mini" data-step="wmod-Mazza" data-delta="-1">−</button><input class="modCompact" id="wmod-Mazza" type="number" value="0" data-act="mod"><button class="mini" data-step="wmod-Mazza" data-delta="1">+</button>&nbsp;<span class="equipCompact"><input type="checkbox" data-act="eq"></span></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <footer style="text-align:center; color:var(--muted); font-size:12px">Salvataggi locali su questo dispositivo. Nessun dato inviato altrove.</footer>
  </div>

  <div class="toast" id="toast">Massimo 2 armi equipaggiate</div>

<script>
(function(){
  const SKEY = 'lw_sheet_state_v5';
  const HKEY = 'lw_sheet_hist_v5';

  const q = (sel, root=document) => root.querySelector(sel);
  const qa = (sel, root=document) => Array.from(root.querySelectorAll(sel));

  // DOM refs
  const cmbTotal = q('#cmbTotal');
  const cmbBase  = q('#cmbBase');
  const cmbW1    = q('#cmbW1'); // disciplina kai only
  const cmbW2    = q('#cmbW2');
  const cmbMods  = [q('#cmbM1'), q('#cmbM2'), q('#cmbM3')];

  const endCur   = q('#endCur');
  const endTot   = q('#endTot');
  const endMods  = [q('#endM1'), q('#endM2'), q('#endM3'), q('#endM4'), q('#endM5')];

  const armLine1 = q('#armLine1');
  const armLine2 = q('#armLine2');

  const autosave = q('#autosave');
  const autosaveMins = q('#autosaveMins');
  const saveNow  = q('#saveNow');
  const lastSave = q('#lastSave');
  const restore1 = q('#restore1');
  const restore2 = q('#restore2');
  const restore3 = q('#restore3');
  const toastEl  = q('#toast');
  const muteToggle = q('#muteToggle');

  // Sound (WebAudio simple)
  let ac;
  function beep(freq=660, dur=80, type='sine', vol=0.05){
    if(muteToggle.checked) return;
    try{
      ac = ac || new (window.AudioContext||window.webkitAudioContext)();
      const o = ac.createOscillator(); const g = ac.createGain();
      o.type = type; o.frequency.value = freq; g.gain.value = vol;
      o.connect(g); g.connect(ac.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, dur);
    }catch(e){}
  }

  function toast(msg){
    toastEl.textContent = msg || 'Avviso';
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 1500);
  }

  // Collect weapon rows
  const weaponRows = qa('table.weaponList tbody tr');
  // Local state mirror
  const weaponState = Array.from(weaponRows).map(row => ({
    name: row.getAttribute('data-name'),
    fav:  false, // Disciplina
    eq:   false,
    mod:  0
  }));

  function syncRowsFromState(){
    weaponRows.forEach((row, i) => {
      row.querySelector('input[data-act="disc"]').checked = !!weaponState[i].fav;
      row.querySelector('input[data-act="eq"]').checked   = !!weaponState[i].eq;
      row.querySelector('input[data-act="mod"]').value    = weaponState[i].mod || 0;
      row.classList.toggle('kaiFav', !!weaponState[i].fav);
    });
  }

  function syncStateFromRows(){
    weaponRows.forEach((row, i) => {
      weaponState[i].fav = row.querySelector('input[data-act="disc"]').checked;
      weaponState[i].eq  = row.querySelector('input[data-act="eq"]').checked;
      weaponState[i].mod = Number(row.querySelector('input[data-act="mod"]').value || 0);
    });
  }

  function updateArmamentoLines(){
    const eq = weaponState.filter(w=>w.eq).map(w=>w.name);
    armLine1.textContent = eq[0] || '—';
    armLine2.textContent = eq[1] || '—';
  }

  function computeWeaponMods(){
    // Disciplina Kai box (cmbW1) shows ONLY the +2 from the selected disciplined weapon if it's also equipped.
    const discIndex = weaponState.findIndex(w=>w.fav);
    let discBonus = 0;
    if(discIndex>=0 && weaponState[discIndex].eq) discBonus = 2;
    cmbW1.value = discBonus;

    // Weapons' individual "mod" values are applied only if that weapon is equipped.
    const weaponMods = weaponState.filter(w=>w.eq).reduce((s,w)=> s + (Number(w.mod)||0), 0);

    return discBonus + weaponMods;
  }

  function computeCmbTotal(){
    const base = Number(cmbBase.value||0);
    const manual = cmbMods.reduce((s,el)=>s + (Number(el.value)||0), 0);
    const weaps = computeWeaponMods();
    const eqCount = weaponState.filter(w=>w.eq).length;
    const noWeaponMalus = eqCount===0 ? -4 : 0;
    const total = base + manual + weaps + noWeaponMalus;
    q('#cmbTotal').textContent = total;
  }

  function computeEndurance(){
    const cur = Number(endCur.value||0);
    const mods = endMods.reduce((s,el)=>s + (Number(el.value)||0), 0);
    const adjusted = cur + mods;
    endCur.title = `Attuale con modificatori: ${adjusted}`;
  }

  function syncUI(){
    computeCmbTotal();
    computeEndurance();
    updateArmamentoLines();
  }

  // Enforce "only one disciplina" and "max 2 equip"
  document.addEventListener('change', (e)=>{
    const t = e.target;
    if(!(t instanceof HTMLInputElement)) return;
    if(t.matches('input[data-act="disc"]')){
      weaponRows.forEach(row => { const cb = row.querySelector('input[data-act="disc"]'); if(cb!==t) cb.checked = false; });
      beep(720,70,'triangle');
    }
    if(t.matches('input[data-act="eq"]')){
      const checked = weaponRows.filter(r=>r.querySelector('input[data-act="eq"]').checked);
      if(checked.length>2){
        t.checked = false;
        toast('Massimo 2 armi equipaggiate');
        beep(240,120,'square');
      }else{
        beep(600,60,'sine');
      }
    }
    if(t.matches('input[data-act="mod"]')){
      beep(500,40,'sine');
    }
    syncStateFromRows();
    syncUI();
    markDirty();
    syncRowsFromState();
  });

  // Stepper buttons (±) — avoid focusing input to not pop the keyboard
  document.addEventListener('click', (e)=>{
    const el = e.target.closest('button.mini[data-step]');
    if(!el) return;
    e.preventDefault();
    const id = el.getAttribute('data-step');
    const delta = Number(el.getAttribute('data-delta'))||0;
    const inp = document.getElementById(id);
    const cur = Number(inp.value||0);
    inp.value = cur + delta;
    inp.dispatchEvent(new Event('input', {bubbles:true}));
    beep(delta>0?700:420,50,'sine');
  }, {passive:true});

  // Inputs
  ;[cmbBase, ...cmbMods, endCur, endTot, ...endMods].forEach(inp=>{
    inp.addEventListener('input', ()=>{ syncUI(); markDirty(); });
  });

  function nowStr(){
    const d=new Date(); const p=n=>String(n).padStart(2,'0');
    return `${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
  }

  // Save / Load
  function readState(){
    syncStateFromRows();
    return {
      cmbBase: Number(cmbBase.value||0),
      cmbMods: cmbMods.map(el=>Number(el.value||0)),
      cmbW1: Number(cmbW1.value||0),
      cmbW2: Number(cmbW2.value||0),
      endCur: Number(endCur.value||0),
      endTot: Number(endTot.value||0),
      endMods: endMods.map(el=>Number(el.value||0)),
      weapons: weaponState.map(w=>({...w})),
      autosave: autosave.checked,
      autosaveMins: Number(autosaveMins.value||5),
      mute: muteToggle.checked
    };
  }
  function writeState(s){
    cmbBase.value = s.cmbBase||0;
    s.cmbMods?.forEach((v,i)=>{ if(cmbMods[i]) cmbMods[i].value = v; });
    endCur.value = s.endCur||0;
    endTot.value = s.endTot||0;
    s.endMods?.forEach((v,i)=>{ if(endMods[i]) endMods[i].value = v; });
    if(Array.isArray(s.weapons)){
      weaponRows.forEach((row,i)=>{
        const w = s.weapons[i]; if(!w) return;
        row.querySelector('input[data-act="disc"]').checked = !!w.fav;
        row.querySelector('input[data-act="eq"]').checked   = !!w.eq;
        row.querySelector('input[data-act="mod"]').value    = w.mod || 0;
        row.classList.toggle('kaiFav', !!w.fav);
        weaponState[i] = { name: weaponState[i].name, fav:!!w.fav, eq:!!w.eq, mod:Number(w.mod||0) };
      });
    }
    autosave.checked = !!s.autosave;
    if(s.autosaveMins){ autosaveMins.value = String(s.autosaveMins); }
    muteToggle.checked = !!s.mute;
    syncUI();
  }

  function saveState(){
    const s = readState();
    localStorage.setItem(SKEY, JSON.stringify(s));
    lastSave.textContent = nowStr();
    // rotate snapshots (keep last 3)
    let hist = [];
    try{ hist = JSON.parse(localStorage.getItem(HKEY)||'[]'); }catch{ hist=[]; }
    hist.push({ts: Date.now(), time: new Date().toLocaleString(), s});
    while(hist.length>3) hist.shift();
    localStorage.setItem(HKEY, JSON.stringify(hist));
    updateRestoreButtons();
    dirty=false;
  }
  function loadState(){
    try{
      const s = JSON.parse(localStorage.getItem(SKEY)||'{}');
      if(s && Object.keys(s).length){ writeState(s); }
      else { syncRowsFromState(); syncUI(); }
    }catch{ syncRowsFromState(); syncUI(); }
    updateRestoreButtons();
  }
  function updateRestoreButtons(){
    let hist = [];
    try{ hist = JSON.parse(localStorage.getItem(HKEY)||'[]'); }catch{ hist=[]; }
    const slots = hist.slice(-3);
    [restore1, restore2, restore3].forEach((btn,ix)=>{
      const item = slots[ix];
      if(item){ btn.textContent = `Slot ${ix+1} (${new Date(item.ts).toLocaleTimeString()})`; btn.disabled=false; }
      else{ btn.textContent = `Slot ${ix+1}`; btn.disabled=true; }
    });
  }
  [restore1, restore2, restore3].forEach((btn,ix)=>{
    btn.addEventListener('click', ()=>{
      let hist = [];
      try{ hist = JSON.parse(localStorage.getItem(HKEY)||'[]'); }catch{}
      const slots = hist.slice(-3);
      const item = slots[ix];
      if(!item) return;
      writeState(item.s);
      localStorage.setItem(SKEY, JSON.stringify(item.s));
      lastSave.textContent = 'ripristino ' + new Date(item.ts).toLocaleTimeString();
      beep(520,70,'sine');
    });
  });

  // autosave / manual
  let timer = null;
  function startAutosave(){
    if(timer) clearInterval(timer);
    if(autosave.checked){
      const mins = Math.max(1, Number(autosaveMins.value||5));
      timer = setInterval(()=>{ if(dirty) saveState(); }, mins*60*1000);
    }
  }
  autosave.addEventListener('change', ()=>{ startAutosave(); beep(480,60,'sine'); });
  autosaveMins.addEventListener('change', ()=>{ startAutosave(); beep(560,60,'sine'); });
  saveNow.addEventListener('click', ()=>{ saveState(); beep(680,80,'triangle'); });
  let dirty=false;
  function markDirty(){ dirty=true; }

  // Init
  loadState();
  startAutosave();
  window.addEventListener('beforeunload', ()=>{ if(dirty) saveState(); });
})();
</script>
</body>
</html>
